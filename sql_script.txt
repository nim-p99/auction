DROP DATABASE IF EXISTS auction_site;

CREATE DATABASE auction_site
  DEFAULT CHARACTER SET utf8
  DEFAULT COLLATE utf8_general_ci;

DROP USER IF EXISTS 'auctionadmin';
FLUSH PRIVILEGES;

CREATE USER 'auctionadmin'
  IDENTIFIED BY 'adminpassword';

GRANT SELECT, UPDATE, INSERT, DELETE
  ON auction_site.*
  TO 'auctionadmin';

USE auction_site;

CREATE TABLE address (
  address_id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  address_line1 VARCHAR(50) NOT NULL,
  address_line2 VARCHAR(50),
  city VARCHAR(30) NOT NULL,
  postal_code VARCHAR(15) NOT NULL 
)ENGINE=InnoDB;

CREATE TABLE users (
  user_id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  email VARCHAR(255) NOT NULL UNIQUE,
  password VARCHAR(255) NOT NULL,
  username VARCHAR(30) NOT NULL UNIQUE,
  acc_active BOOLEAN NOT NULL DEFAULT TRUE,
  first_name VARCHAR(30) NOT NULL,
  family_name VARCHAR(30) NOT NULL,
  phone_number VARCHAR(15) DEFAULT NULL,
  address_id INT UNSIGNED DEFAULT NULL,
  FOREIGN KEY (address_id) REFERENCES address(address_id)
)ENGINE=InnoDB;

CREATE TABLE admin (
  admin_id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  user_id INT UNSIGNED NOT NULL UNIQUE,
  FOREIGN KEY (user_id) REFERENCES users(user_id)
)ENGINE=InnoDB;

CREATE TABLE seller (
  seller_id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  user_id INT UNSIGNED NOT NULL UNIQUE,
  avg_seller_rating DECIMAL(3, 2) DEFAULT 0.00,
  FOREIGN KEY (user_id) REFERENCES users(user_id)
)ENGINE=InnoDB;

CREATE TABLE buyer (
  buyer_id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  user_id INT UNSIGNED NOT NULL UNIQUE,
  avg_buyer_rating DECIMAL(3,2) DEFAULT 0.00,
  FOREIGN KEY (user_id) REFERENCES users(user_id)
)ENGINE=InnoDB;

CREATE TABLE category (
  category_id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  category_name VARCHAR(100) NOT NULL UNIQUE,
  parent_category INT UNSIGNED NULL,
  FOREIGN KEY (parent_category) REFERENCES category(category_id)
)ENGINE=InnoDB;


CREATE TABLE item (
  item_id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  category_id INT UNSIGNED NOT NULL,
  title VARCHAR(100) NOT NULL,
  description TEXT NOT NULL,
  photo_url VARCHAR(512), -- stores path to image file 
  item_condition VARCHAR(30) NOT NULL,
  FOREIGN KEY (category_id) REFERENCES category(category_id)
)ENGINE=InnoDB;

CREATE TABLE auction (
  auction_id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  seller_id INT UNSIGNED NOT NULL,
  item_id INT UNSIGNED NOT NULL UNIQUE, -- unique as 1:1 relationship
  start_bid DECIMAL(10,2) NOT NULL,
  reserve_price DECIMAL(10,2),
  buy_now_price DECIMAL(10,2),
  start_date_time DATETIME NOT NULL,
  end_date_time DATETIME NOT NULL,
  -- current_price INT UNSIGNED,
  -- num_bids INT UNSIGNED,
  FOREIGN KEY (seller_id) REFERENCES seller(seller_id),
  FOREIGN KEY (item_id) REFERENCES item(item_id)
)ENGINE=InnoDB;

CREATE TABLE watchlist (
  watchlist_id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  user_id INT UNSIGNED NOT NULL,
  auction_id INT UNSIGNED NOT NULL,
  -- prevent user from watching same auction buy_now_price
  UNIQUE KEY (user_id, auction_id),
  FOREIGN KEY (user_id) REFERENCES users(user_id),
  FOREIGN KEY (auction_id) REFERENCES auction(auction_id)
)ENGINE=InnoDB;

CREATE TABLE bids (
  bid_id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  buyer_id INT UNSIGNED NOT NULL,
  auction_id INT UNSIGNED NOT NULL,
  amount DECIMAL(10,2) NOT NULL,
  date DATETIME NOT NULL,
  FOREIGN KEY (buyer_id) REFERENCES buyer(buyer_id),
  FOREIGN KEY (auction_id) REFERENCES auction(auction_id)
)ENGINE=InnoDB;

CREATE TABLE message (
  message_id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  message TEXT NOT NULL,
  seller_id INT UNSIGNED NOT NULL,
  buyer_id INT UNSIGNED NOT NULL,
  date DATETIME NOT NULL,
  FOREIGN KEY (seller_id) REFERENCES seller(seller_id),
  FOREIGN KEY (buyer_id) REFERENCES buyer(buyer_id)
)ENGINE=InnoDB;

CREATE TABLE transaction (
  transaction_id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  bid_id INT UNSIGNED NOT NULL,
  date DATETIME NOT NULL,
  seller_rating DECIMAL(3,2) NULL,
  seller_comments TEXT NOT NULL,
  buyer_rating DECIMAL(3,2) NULL,
  buyer_comments TEXT NULL,
  FOREIGN KEY (bid_id) REFERENCES bids(bid_id)
)ENGINE=InnoDB;


USE auction_site;


-- Sample addresses -----------------------------------------------

INSERT INTO address (address_line1, address_line2, city, postal_code) VALUES
('123 Main St', NULL, 'London', 'E1 1AA'),
('456 Oak Rd', 'Flat 2B', 'Manchester', 'M2 2BB'),
('789 Pine Ave', NULL, 'Birmingham', 'B3 3CC');


-- Sample users (hashed passwords, original password in comment) -----

INSERT INTO users (email, password, username, acc_active, first_name, family_name, phone_number, address_id) VALUES
('admin@auction.com', '$2y$10$xn7.XhjX6nwS8FgM4SKyBOoTHJls4qUr3B/QBeezkz3..ZVyjQjc.', 'AdminUser', TRUE, 'Adam', 'Smith', '07123456789', 1),  -- password: admin123
('seller1@shop.com', '$2y$10$St7f0E.UlzXPfyPl1NXL6.Ia49fRjLwjHr1COU0ieqKKqWKjpNLCC', 'ProSeller', TRUE, 'Nim', 'Johnson', NULL, NULL), -- password: SellerPass1
('seller2@shop.com', '$2y$10$D8BcCDpFn3GLplPaaxwsbeackuvsKmIGHb4xS4Zefpl10AsK3qpkO', 'ArtisanGoods', TRUE, 'Armando', 'Brown', '07234567890', 2), -- password: ArtGoods22
('buyer1@mail.com', '$2y$10$.HupXbqORBStQcmdguxErut5CGWsy3GpzfWs1OgE2FSz5hMYuBXc.', 'HighBidder', TRUE, 'Luke', 'Prince', NULL, NULL), -- password: BuyerPass1
('buyer2@mail.com', '$2y$10$BC1SABu52MGtTlLYWvr1f.5cacRJ3YFnXRZEmjzIZlp9tuM7sKXzq', 'BargainHunter', TRUE, 'Francesca', 'Adams', '07345678901', 3); -- password: Bargain22


-- Sample admin, buyer, seller -------------------------------


INSERT INTO admin (user_id) VALUES (1);

INSERT INTO seller (user_id, avg_seller_rating) VALUES
(2, 4.80),
(3, 4.25);

INSERT INTO buyer (user_id, avg_buyer_rating) VALUES
(4, 5.00),
(5, 4.50);

-- Categories ----------------------------------------------------

INSERT INTO category (category_id, category_name, parent_category) VALUES
(1, 'Electronics', NULL),
(2, 'Home & Garden', NULL),
(3, 'Vintage Collectibles', NULL),
(4, 'Laptops', 1), -- Child of Electronics
(5, 'Smartphones', 1), -- Child of Electronics
(6, 'Artwork', 3), -- Child of Vintage Collectibles
(7, 'Furniture', 2); -- Child of Home & Garden

#TODO: Make sure there are no errors regarding self referencing
#SELECT @max_cat := MAX(category_id) FROM category;
#ALTER TABLE category AUTO_INCREMENT = @max_cat + 1;

INSERT INTO item (item_id, category_id, title, description, photo_url, item_condition) VALUES
(101, 4, 'Mint Condition Laptop X1', 'High-performance laptop, barely used.', 'url/laptop_x1.jpg', 'New'),
(102, 6, '1920s Art Deco Poster', 'Original print from Paris, framed.', 'url/art_deco.jpg', 'Used - Good'),
(103, 7, 'Mid-Century Modern Chair', 'Unique swivel chair, excellent upholstery.', 'url/chair_mcm.jpg', 'Used - Fair'),
(104, 5, 'iphone 15 pro max', 'space grey, 256gb, slightly cracked screen', 'url/iphone.jpg', 'Used - Fair'),
(105, 5, 'iphone 17 pro max', 'red, 256gb, slightly cracked screen', 'url/iphone.jpg', 'Used - Fair');


INSERT INTO auction (auction_id, seller_id, item_id, start_bid, reserve_price, buy_now_price, start_date_time, end_date_time) VALUES
(501, 1, 101, 500.00, 750.00, 999.99, '2025-11-01 10:00:00', '2025-11-08 10:00:00'), -- closed
(502, 2, 102, 100.00, 200.00, NULL, '2025-11-12 12:00:00', '2025-12-01 12:00:00'), -- Active
(503, 1, 103, 50.00, NULL, 150.00, '2026-11-05 14:00:00', '2026-11-12 14:00:00'), -- Future/Upcoming
(504, 2, 104, 90.00, 400.00, 1000.00, '2025-11-16 12:00:00', '2026-02-16 12:00:00'),
(505, 2, 105, 95.00, 500.00, 2000.00, '2025-11-16 12:00:00', '2026-02-16 12:00:00');

-- Diana (buyer_id 1 / user_id 4) watches Laptop (501)
INSERT INTO watchlist (user_id, auction_id) VALUES (4, 501);
-- Eve (buyer_id 2 / user_id 5) watches Chair (503)
INSERT INTO watchlist (user_id, auction_id) VALUES (5, 503);

-- Bids for Auction 501 (Laptop, Active)
INSERT INTO bids (bid_id, buyer_id, auction_id, amount, date) VALUES
(1001, 1, 501, 500.00, '2025-11-01 10:05:00'),
(1002, 2, 501, 650.00, '2025-11-02 11:30:00');

-- Bids for Auction 502 (Poster, Closed) - Winning Bid
INSERT INTO bids (bid_id, buyer_id, auction_id, amount, date) VALUES
(1003, 1, 502, 150.00, '2025-10-26 15:00:00'),
(1004, 2, 502, 175.00, '2025-10-27 10:00:00'),
(1005, 1, 502, 210.00, '2025-10-31 09:00:00'); -- Highest Bid (bid_id 1005)


INSERT INTO message (message_id, seller_id, buyer_id, message, date) VALUES
(1, 1, 1, 'Can you confirm the laptop battery life?', '2025-11-02 15:00:00'),
(2, 1, 1, 'Estimated 8 hours under light use.', '2025-11-02 15:10:00');


-- Transaction for Auction 502, won by buyer_id 1 with bid_id 1005.
INSERT INTO transaction (bid_id, date, seller_rating, seller_comments, buyer_rating, buyer_comments) VALUES
(1005, '2025-11-01 13:00:00', 4.50, 'Excellent communication, fast payment.', NULL, NULL); -- Buyer rating/comments are pending
